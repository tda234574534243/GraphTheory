<!DOCTYPE html>
<html lang="vi">

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <title>Đồ thị từ JSON</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .container-fluid {
            background-image: url("./images/pexels-8moments-1323550.jpg");
            background-repeat: no-repeat;
            background-size: cover; /* Đảm bảo hình ảnh được phóng to để phủ đầy màn hình */
            background-position: center; /* Căn giữa hình ảnh */
            height: 100vh; /* Đặt chiều cao của container là chiều cao toàn bộ màn hình */
            width: 100%; /* Đảm bảo chiều rộng của container là 100% */
            object-fit: cover; /* Đảm bảo hình ảnh sẽ được kéo giãn để phủ kín mà không bị biến dạng */
        }
        #result {
            width: 900px; /* Chiếm toàn bộ chiều rộng của container */
            height: 50px; /* Tăng chiều cao của ô nhập liệu */
            font-size: 16px; /* Tăng kích thước chữ */
            padding: 10px; /* Tăng khoảng cách bên trong */
        }
        svg {
            border: 4px solid #130707;
            background-color: rgb(142, 142, 180);
        }

        .node {
            stroke: #e1f2a0;
            stroke-width: 1.5px;
        }

        .link {
            fill: none;
            stroke-opacity: 0.6;
        }

        text {
            fill: rgb(233, 237, 32);
            /* Đặt màu chữ là vàng cho tất cả các text */
        }

        .box-right .findPath {
            position: relative;
            border: none;
            width: 100px;
            height: 50px;
            background-color: aliceblue;
            color: #130707;
            font-weight: bold;
            border-radius: 10%;
            box-shadow: 0 0 0 0 rgba(0, 255, 255, 0.4);
            overflow: hidden;
            transition: transform 0.3s ease-in-out;
        }

        .box-right .findPath:hover {
            box-shadow: 0 0 15px 10px rgba(240, 39, 39, 0.6);
            background-color: rgb(255, 214, 31);
            color: rgb(205, 26, 71);
            /* Hiệu ứng đường sáng chạy quanh border */
            transform: translateY(-10px);
            /* Nổi lên khi hover */
        }

        .box-right .findPath .light {
            position: absolute;
            background: aqua;
            border-radius: 2px;
        }

        .box-right .findPath .top,
        .box-right .findPath .bottom {
            height: 3px;
            width: 100%;
        }

        .box-right .findPath .left,
        .box-right .findPath .right {
            width: 3px;
            height: 100%;
        }

        .box-right .findPath .top {
            top: 0;
            left: -100%;
            /* Bắt đầu ở ngoài cùng bên trái */
            animation: moveRight 2s linear infinite;
        }

        .box-right .findPath .right {
            top: -100%;
            right: 0;
            animation: moveDown 2s linear infinite;
        }

        .box-right .findPath .bottom {
            bottom: 0;
            right: -100%;
            /* Bắt đầu ở ngoài cùng bên phải */
            animation: moveLeft 2s linear infinite;
        }

        .box-right .findPath .left {
            bottom: -100%;
            left: 0;
            animation: moveUp 2s linear infinite;
        }

        /* Keyframes cho chuyển động */
        @keyframes moveRight {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        @keyframes moveDown {
            0% {
                top: -100%;
            }

            100% {
                top: 100%;
            }
        }

        @keyframes moveLeft {
            0% {
                right: -100%;
            }

            100% {
                right: 100%;
            }
        }

        @keyframes moveUp {
            0% {
                bottom: -100%;
            }

            100% {
                bottom: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid d-lg-flex">
        <div class="box-left p-lg-3">
            <h1 style="color: white;">Bản đồ sơ lược về các Quận ở TP Hồ Chí Minh</h1>
            <svg width="950" height="700" style="align-items: center;"></svg>
        </div>
        <div class="box-right m-auto">
            <div class="col-md w-50 m-auto">
                <select id="vehicle" class="form-select form-select-lg mb-3" aria-label="Large select example">
                    <option value="Xe máy">Xe máy</option>
                    <option value="Xe ô tô">Xe ô tô</option>
                    <option value="Đi bộ">Đi bộ</option>
                </select>
            </div>
            <div class="row g-2 mb-5">
                <div class="col-md">
                    <select id="vertexEnd" class="form-select form-select-lg mb-3" aria-label="Large select example">
                    </select>
                </div>
                <div class="col-md">
                    <select id="vertexStart" class="form-select form-select-lg mb-3" aria-label="Large select example">
                    </select>
                </div>
            </div>
            <div class="col-md">
                <label for="speed">Chọn tốc độ:</label>
                <select id="speed" class="form-select form-select-lg mb-3" aria-label="Chọn tốc độ">
                    <option value="1">1x (Bình thường)</option>
                    <option value="2">2x (Nhanh hơn)</option>
                </select>
            </div>
            <div class="row">
                <div class="col-md">
                    <button type="button" class="findPath">
                        <span class="light top"></span>
                        <span class="light right"></span>
                        <span class="light bottom"></span>
                        <span class="light left"></span>
                        Tìm đường</button>
                </div>
                
                <div class="col-md h-25 input-group">
                    <input type="text" id="result" class="form-control"
                        aria-label="Dollar amount (with dot and two decimal places)">
                    
                </div>
            </div>
            <div class="row icons mt-5">
                <div class="col-md icon-fb">
                    <i class="bi bi-facebook" style="font-size: 30px; color: blue;"></i>
                </div>
                <div class="col-md icon-ing">
                    <i class="bi bi-instagram" style="font-size: 30px; color: rgb(193, 78, 25)"></i>
                </div>
                <div class="col-md icon-youtube">
                    <i class="bi bi-youtube" style="font-size: 30px; color: red;"></i>
                </div>
                <div class="col-md icon-mail">
                    <i class="bi bi-envelope-paper-fill" style="font-size: 30px; color: rgb(42, 39, 33);"></i>
                </div>
                <div class="col-md icon-tiktok">
                    <i class="bi bi-tiktok" style="font-size: 30px;"></i>
                </div>
                
            </div>
        </div>
        
    </div>
    
    <script>

        d3.json("graph.json").then(graph => {
            const svg = d3.select("svg");
            const width = +svg.attr("width");
            const height = +svg.attr("height");

            // Khởi tạo mô phỏng
            const simulation = d3.forceSimulation(graph.nodes)
                .force("link", d3.forceLink().id(d => d.id).distance(d => d.distance * 25)) // Liên kết
                .force("charge", d3.forceManyBody().strength(-500)) // Lực tác động
                .force("center", d3.forceCenter(width / 2.2, height / 2));

            // Vẽ các cạnh
            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(graph.edges)
                .enter().append("line")
                .attr("class", "link")
                .attr("id", d => `link-${d.link}`)
                .attr("stroke", "black")

            // Vẽ các nút
            const node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("g")  // Sử dụng nhóm cho mỗi nút
                .data(graph.nodes)
                .enter().append("g")  // Tạo nhóm cho mỗi nút
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x}, ${d.y})`) // Gán vị trí từ x, y
                .call(d3.drag() // Tạo khả năng kéo cho các nút
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            // Thêm hình tròn vào nhóm
            node.append("circle")
                .attr("r", 9)
                .attr("class", "node")
                .attr("fill", "#69b3a2")
                .attr("id", d => d.id.replace(/\s+/g, '_'));  // Thay thế khoảng trắng bằng dấu gạch dưới


            // Thêm văn bản vào nhóm
            node.append("text")
                .attr("dy", -10)  // Đặt vị trí văn bản phía trên nút
                .attr("text-anchor", "middle")  // Căn giữa văn bản
                .style("font-size", "12px")  // Thiết lập kích thước văn bản
                .text(d => d.id);  // Hiển thị id từ dữ liệu JSON

            // Gán links cho simulation
            simulation.force("link").links(graph.edges);
            simulation.nodes(graph.nodes).on("tick", ticked);

            // Cập nhật vị trí các cạnh dựa trên vị trí của các nút

            node.attr("transform", d => `translate(${d.x}, ${d.y})`);
            function ticked() {
                // Cập nhật vị trí các cạnh
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                // Cập nhật vị trí các nút
                node
                    .attr("transform", d => `translate(${d.x}, ${d.y})`);  // Sử dụng transform để định vị các nhóm
            }

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            const vertexStart = document.getElementById("vertexStart");
            const vertexEnd = document.getElementById("vertexEnd");

            // Thêm các nút vào select cho vertexStart
            graph.nodes.forEach(node => {
                const option = document.createElement("option");
                option.value = node.id;  // Gán giá trị của option là id của nút
                option.textContent = node.id;  // Hiển thị tên nút
                vertexStart.appendChild(option);  // Thêm option vào select
            });

            // Thêm các nút vào select cho vertexEnd
            graph.nodes.forEach(node => {
                const option = document.createElement("option");
                option.value = node.id;  // Gán giá trị của option là id của nút
                option.textContent = node.id;  // Hiển thị tên nút
                vertexEnd.appendChild(option);  // Thêm option vào select
            });
            const findPathButton = document.querySelector('.findPath');
            findPathButton.addEventListener('click', FindPath);

            function Dijkstra(graph, startID, endID, vehicles) {
                console.log(vehicles);

                const distances = {};
                const parent = {};
                const queue = new PriorityQueue();

                graph.nodes.forEach(node => {
                    distances[node.id] = Infinity;
                    parent[node.id] = null;
                });

                distances[startID] = 0;
                queue.enqueue(startID, 0);

                while (!queue.isEmpty()) {
                    const { element: currentNodeId } = queue.dequeue();

                    // Kiểm tra xem currentNodeId có đúng không
                    console.log(`Current Node: ${currentNodeId}`);
                    graph.edges.forEach(edge => {
                    });
                    if (currentNodeId === endID) break;

                    const neighbors = graph.edges.filter(edge =>
                        (edge.source.id === currentNodeId || edge.target.id === currentNodeId) && edge.vehicle === vehicles);

                    console.log(`Neighbors of ${currentNodeId}:`, neighbors);

                    neighbors.forEach(edge => {
                        const neighborId = edge.source.id === currentNodeId ? edge.target.id : edge.source.id;
                        const newDistance = distances[currentNodeId] + edge.distance;

                        if (newDistance < distances[neighborId]) {
                            distances[neighborId] = newDistance;
                            parent[neighborId] = currentNodeId;
                            queue.enqueue(neighborId, newDistance);
                        }
                    });
                }

                const path = [];
                const edgesToHighlight = [];
                let current = endID;

                while (current) {
                    path.unshift(current);
                    const prev = parent[current];

                    if (prev) {
                        const edge = graph.edges.find(edge =>
                            (edge.source.id === current && edge.target.id === prev) ||
                            (edge.source.id === prev && edge.target.id === current));
                        if (edge) {
                            edgesToHighlight.push(edge.link);
                        }
                    }
                    current = prev;
                }
                return { path, edgesToHighlight, distance: distances[endID] };
            }

            class PriorityQueue {
                constructor() {
                    this.elements = [];
                }

                enqueue(element, priority) {
                    this.elements.push({ element, priority });
                    this.elements.sort((a, b) => a.priority - b.priority); // Sắp xếp theo độ ưu tiên
                }

                dequeue() {
                    return this.elements.shift(); // Lấy phần tử đầu tiên (có độ ưu tiên cao nhất)
                }

                isEmpty() {
                    return this.elements.length === 0;
                }
            }

            function FindPath() {
    const selectVehicle = document.getElementById("vehicle").value;
    const selectedStart = vertexStart.value;
    const selectedEnd = vertexEnd.value;
    const speedFactor = parseFloat(document.getElementById("speed").value); // Lấy tốc độ từ người dùng

    // Đặt màu cho các node
    svg.selectAll(".node").attr("fill", "#69b3a2");
    svg.select(`#${selectedStart.replace(/\s+/g, '_')}`).attr("fill", "red");
    svg.select(`#${selectedEnd.replace(/\s+/g, '_')}`).attr("fill", "red");

    // Khởi tạo trạng thái để theo dõi các bước thử
    let trialEdges = [];  // Các cạnh thử nghiệm

    const { path, edgesToHighlight, distance } = Dijkstra(graph, selectedStart, selectedEnd, selectVehicle);

    // Tô màu tất cả các liên kết về mặc định
    svg.selectAll("line.link").attr("stroke", "black");

    let index = 0; // Đánh dấu bước hiện tại trong đường đi
    let intervalId = setInterval(() => {
        if (index < edgesToHighlight.length) {
            const edgeId = edgesToHighlight[index];

            // Đánh dấu các cạnh đã thử
            if (trialEdges.includes(edgeId)) {
                svg.select(`#link-${edgeId}`).attr("stroke", "red").attr("stroke-width", 3);
            } else {
                svg.select(`#link-${edgeId}`).attr("stroke", "yellow");
            }

            // Nếu đã thử mà không thành công, thêm vào mảng các cạnh thử nghiệm
            trialEdges.push(edgeId);
            index++;
        } else {
            clearInterval(intervalId); // Dừng khi đã vẽ hết
        }
    }, 1000 / speedFactor); // Điều chỉnh tốc độ (1000ms = 1s, điều chỉnh tùy theo tốc độ)

    // Nối các điểm trong đường đi vào một chuỗi
    const pathString = path.join(" -> ");

    // Hiển thị đường đi trong ô textbox
    document.getElementById("result").value = pathString;

    // Hiển thị khoảng cách nếu có
    if (distance === Infinity) {
        alert(`Không có đường đi từ ${selectedStart} đến ${selectedEnd} bằng ${selectVehicle}`);
    } else {
        document.getElementById("result").value += " | Khoảng cách: " + distance + " km";
    }
}

        }).catch(error => {
            console.error('Lỗi khi tải file JSON:', error);
        });


    </script>
</body>

</html>